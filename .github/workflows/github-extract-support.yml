name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]

jobs:
  check-commits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Retrieve commits for release
        id: commits
        run: |
          previous_tag=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))
          echo "::set-output name=commits::$(git log --pretty=format:'%h' --abbrev-commit ${previous_tag}..${{ github.event.release.tag_name }})"

      - name: Get correlated issues
        id: issues
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/issues
          headers: |
            authorization: token ${{ secrets.GITHUB_TOKEN }}
          query: |
            q=sha:(${{ steps.commits.outputs.commits }})

      - name: Search for SEC-123
        id: search
        run: |
          pattern="SEC-123"
          matches=$(echo "${{ steps.issues.outputs.data }}" | jq -r '.[].body' | grep "$pattern")

          if [[ -n "$matches" ]]; then
            echo "::set-output name=found::true"
          else
            echo "::set-output name=found::false"
          fi

